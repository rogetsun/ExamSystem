/*!
 * ExamSystem - compressed JS
 * @licence ExamSystem - v1.0.0 (2016-01-13)
  */
angular.module("student-app",["ui.router","ngDialog","util.httpInterceptor","uv.service.loading","uv.service.dialog","uv.service.tip","resource.student-all","student-all.controller"]).config(["$stateProvider","$urlRouterProvider","uvLoadingProvider","$locationProvider",function(a,b,c,d){c.setLoadingGif("assets/diy/uv-loading/loading.gif"),d.html5Mode(!0),b.otherwise("/index/main"),a.state("index",{url:"/index","abstract":!0,template:"<ui-view></ui-view>"}).state("index.main",{url:"/main",templateUrl:"app/student/index/template/index.html",controller:"studentIndexController"}).state("index.exam",{url:"/exam/{exam_id}",templateUrl:"app/student/index/template/exam.html",controller:"studentExamController"})}]).run(["$rootScope","$timeout","stdAllService",function(a,b,c){}]),angular.module("student-all.controller",["uv.directive.clock","uv.filter"]).controller("studentIndexController",["$scope","$timeout","ngDialog","uvDialog","stdAllService",function(a,b,c,d,e){e.getLoginStd().then(function(c){a.login_user=c.data,a.now=c.data.now;var d=function(){a.now+=1e3,b(d,1e3)};d()}),e.getCurrentExams().then(function(b){a.exams=b.data}),e.getHisCourseScore().then(function(b){a.his_courses=b.data}),a.showCourseExamHis=function(b){d.showTemplate("exam_his_dialog",a,{_course:b},["$scope","stdAllService",function(a,c){c.selectCourseExamHis(b.cos_id).then(function(b){a._course.exams=b.data})}])},a.logout=function(){window.location="logout"},a.modify_password=function(){return a.user=a.login_user,c.open({scope:a,closeByDocument:!1,showClose:!1,template:"change_password_dialog",overlay:!0,controller:["$scope",function(a){a.valid={},a.change_password=function(){var b={old_password:a.old_password,new_password:a.new_password,new_password_repeat:a.new_password_repeat};return console.log(b),a.valid_old()?(a.valid={},b.new_password?b.new_password!=b.new_password_repeat?(a.valid.new_password_repeat="两次输入的新密码不一致",!1):(b.std_passwd=md5(b.new_password),void e.changePassword(b).then(function(a){a&&"0"==a.ret_code?d.show("修改成功,请重新登录").then(function(){window.location="logout"}):d.show("["+a.ret_code+"],"+a.ret_msg)})):(a.valid.new_password="请输入新密码",!1)):!1},a.valid_old=function(){if(a.valid={},a.old_password){var b=a.user.std_passwd;console.log("real passwd:%s",b);var c=md5(md5(a.old_password));return console.log("old passwd:%s",c),c!=b?(a.valid.old_password="当前密码错误",!1):!0}return a.valid.old_password="请输入当前密码",!1}}]}).closePromise.then(function(a){})}}]).controller("studentExamController",["$scope","$timeout","$state","$stateParams","$filter","ngDialog","uvDialog","stdAllService",function(a,b,c,d,e,f,g,h){console.log("studentExamController"),h.getLoginStd().then(function(b){a.login_user=b.data}),a.wait_flag=!0,d.exam_id?h.getExam(d.exam_id).then(function(b){if(b&&0==b.ret_code){var d=a.exam=b.data;console.log(d),a.last_seconds=parseInt((d.begin_time-d.now)/1e3),a.last_seconds<0&&(a.last_seconds=0,a.wait_flag=!1,i()),console.log("last_seconds="+a.last_seconds)}else a.wait_flag=!1,g.show(b.ret_msg).then(function(){c.go("index.main")})}):c.go("index.main"),a.timeout=function(){b(function(){h.getExam(d.exam_id).then(function(b){a.exam=b.data,i(),a.wait_flag=!1})},1e3)};var i=function(){a.left_seconds=parseInt(a.exam.begin_time)+60*a.exam.duration*1e3-a.exam.now;var c=function(){a.left_seconds-=1e3,a.left_seconds<=0?a.submitExam():b(c,1e3)};c()};a.selectOpt=function(a,b){if("1"==a.is_multi){b.selected=1==b.selected?0:1;var c=e("filter")(a.options,{selected:1});a.answer=[],angular.forEach(c,function(a){this.push(a.opt_title)},a.answer)}else angular.forEach(a.options,function(a){a.selected=0}),b.selected=1,a.answer=b.opt_title},a.confirmExam=function(){g.confirm("确定交卷么?").then(function(b){b&&a.submitExam()})},a.submitExam=function(){var b={};angular.forEach(a.exam.paper.questions,function(a){this[a.qt_id]=a.answer},b),console.log(b),a.exam.answer=b,h.submitExam(a.exam).then(function(a){a&&0==a.ret_code?g.show("考试完毕,你的成绩是:"+a.data).then(function(){c.go("index.main")}):uvTip.showTip("交卷失败,"+a.ret_msg)})}}]),angular.module("uv.filter",[]).filter("timer",[function(){return function(a){if(a){var b=parseInt(a/1e3),c=parseInt(b/60),d=parseInt(c/60);return c%=60,b%=60,d=d>9?d:"0"+d,b=b>9?b:"0"+b,c=c>9?c:"0"+c,d+":"+c+":"+b}return"00:00:00"}}]);